# 要件定義書：Context-Based AI Vocabulary App

**Version:** 5.3 (AI Toggle & Realtime Sync)
**Last Updated:** 2025-12-06

## 1. プロダクトコンセプト
**「文脈ごと切り取り、自分の言葉にする」**
ユーザーは覚えたい単語が含まれる「文脈（文章）」を入力するだけで、AIがその文脈における最適な意味や学習データを自動補完する。
**"Bring Your Own Key" (BYOK)** モデルを採用。

## 2. ユーザー管理・セキュリティ要件
* **認証:** Supabase Auth (Google, Apple, Email).
* **APIキー管理:** クライアントサイド暗号化によるゼロ知識構成。
* **データ制御:** RLSによる厳格なアクセス権管理。

## 3. データモデル方針
* **カテゴリ:** DBカラム (`category_id` / `tags`) は用意するが、UI実装はPhase 2以降。
* **ユーザー設定:** 「AI自動補完のデフォルトON/OFF」などの設定値を保持できる構造とする。

## 4. 機能要件：単語登録・編集の挙動仕様 (Core Features)

### 4.1. 新規登録時の挙動 (Registration Flow)

**基本方針:** 「Fire-and-Forget（撃ちっ放し）」。未入力項目をAIが全補完し、**「多角的な記憶フック」**を自動生成する。

* **UI:** フォーム入力欄 ＋ チャット入力欄 ＋ 「登録(OK)」ボタン。
* **処理ロジック:**
    1.  **入力受付:** 「チャットテキスト」と「フォームの手動入力値」を受け取る。
        * チャットテキストが無い場合は、手動入力値のみを使用する。
    2.  **即時保存 & クローズ:** 手動入力された内容で一旦レコードを作成し、モーダルを閉じる。
    3.  **バックグラウンド補完 (Full Context Generation):**
        * **対象:** 値が空（Empty/Null）である**全ての項目**。
        * **AI生成データ:** 文脈に基づき、以下のフィールドを構造化して生成する。
            * **基本情報:**
                * **意味・品詞:** 文脈に即した最適な定義と品詞。
                * **発音記号 (IPA):** 正しい発音を示す国際音声記号。
            * **記憶のフック (Memory Hooks):**
                * **語源 (Etymology):** 単語の成り立ちやイメージを掴むための語源解説。
                * **類似表現 (Synonyms):** ニュアンスの近い類義語や言い換え表現。
                * **コロケーション:** その単語がよく使われる語の組み合わせ。
            * **実践コンテキスト:**
                * **例文:** 文脈を反映した実用的な例文。
                * **YouGlish連携:** 実際の使用シーンを確認するためのYouTube検索クエリまたはリンク生成。
        * **反映:** 生成された値を該当レコードにマージする。

* **一覧画面での表示 (List View UI):**
    * 当該単語データのいずれかの項目が生成処理中である場合、ステータスアイコン等で「生成中」であることを明示する。
    * **TTS (Text-to-Speech):** リスト上から直接、単語・例文の読み上げ音声を再生可能にする。

### 4.2. 登録後の編集・閲覧時の挙動 (Editing Flow)

**基本方針:** 「Field-Level Gen-AI (項目別生成)」と「Safe Merge (差分更新)」。

* **UI:** 詳細モーダル表示。閲覧と編集の区別がないダイレクト編集UI。
    * **リッチメディア対応:**
        * **音声再生 (TTS):** 単語および例文の横に再生ボタンを配置。
        * **動画埋め込み (YouGlish):** 生成されたリンクに基づき、当該単語が使われているYouTube動画のシーンをウィジェット表示する。
* **A. 手動編集:**
    * 各フィールド（意味、語源、IPA、例文など）を直接タップして修正可能。
    * フォーカスアウト（onBlur）等で自動保存。
* **B. チャット指示によるAI生成:**
    * **ユーザー操作:** チャット欄に「語源をもっと詳しく解説して」「コロケーションをビジネス寄りに更新して」等の指示を入力し送信。
    * **Step 1: 更新対象の特定 (Identification)**
        * AIがチャットの指示内容を解析し、**「更新すべきフィールド（例: `etymology`, `collocation`）」を特定**する。
        * **UI変化:** 特定されたフィールドのみを「生成中（ローディング）」表示に切り替える。
    * **Step 2: コンテンツ生成 (Generation)**
        * AIが対象フィールドの新しい値を生成する。
    * **Step 3: 安全な反映 (Safe Merge)**
        * `prevData` (既存データ) に対して、AIが生成したフィールドの値のみを上書き（Merge）する。
        * 反映後、該当フィールドの「生成中」表示を解除する。

### 4.3. 学習ステータス管理 (Kanban Board)
* **カンバンボード:** 未インプット / インプット済 / 瞬発クリア / 話せる の4段階。
* **一覧表示ロジック:** 前述の通り、内部の項目（意味、例文など）が一つでも生成中であれば、カード全体として「生成中」の視覚フィードバックを与える。


### 4.4. クイズ・検索機能 (Adaptive Vector Quiz)

登録データを活用した4択クイズにより、記憶の定着を図る。単なるランダム出題ではなく、**ベクトル検索技術を用いて「迷いやすい選択肢」を生成する**ことで、学習効果を最大化する。

#### 4.4.1. 誤答生成ロジック (Vector-Based Distractors)
正解以外の3つの選択肢（Distractors）の生成に、Embedding（ベクトル埋め込み）技術を利用する。

* **類似度調整アルゴリズム:**
    * 正解単語とベクトル空間上で「距離が近い」単語を候補として抽出する。
    * **Synonym Trap回避:** コサイン類似度が極端に高い（0.9以上など）単語は「同義語（正解が複数存在してしまう）」のリスクがあるため除外する。
    * **Sweet Spot抽出:** 類似度が適度（例: 0.5 〜 0.8）な範囲にある、「関連性はあるが明らかに異なる単語」をランダムに選出する。これにより「文脈的にありえそうだが間違い」という質の高い選択肢を生成する。

#### 4.4.2. 外部辞書連携オプション (Hybrid Distractor Pool)
ユーザーの登録単語数が少ない段階（コールドスタート問題）の解消と、難易度調整のために、外部データセットを利用可能にする。

* **外部データセット:** 「金フレ（金のフレーズ）」等の標準的な重要単語データをシステム側でベクトル化して保持する。
* **出題範囲トグル (Mix Toggle):** クイズ設定に**「外部辞書の単語を選択肢に含める」**スイッチを設ける。
    * **OFF:** ユーザーが登録した単語のみから誤答を選出（自分の既知語内での識別力チェック）。
    * **ON:** ユーザー登録単語 ＋ 外部データセットから誤答を選出（未知語と既知語の識別力チェック）。これにより、登録単語が1つしかない状態でも即座にクイズ機能を利用可能にする。

#### 4.4.3. 出題モード設定
* **全問ランダム:** 登録済みの全単語から出題。
* **弱点克服 (Wrong Answered):** 過去に間違った（覚えていない）単語から優先出題。
* **復習 (Correct Answered):** 既に正解した単語から忘却曲線を意識して出題。
* **出題数設定:** 1回のクイズ数をユーザーが設定可能（例: 5, 10, 20問）。

#### 4.4.4. クイズUI/UX仕様
* **タイムアタック:**
    * 制限時間: 1問あたり 10秒。
    * プログレスバー: 残り時間を可視化するバーを表示。
    * タイムアウト: 時間切れは「不正解」扱いとし、正解を表示して次へ進む。
* **正誤管理とリスト:**
    * ステータス管理: クイズ結果に基づき、「覚えている（Correct）」「覚えていない（Incorrect）」フラグを更新。
    * リスト表示: 「覚えている単語一覧」「覚えていない単語一覧」を個別に閲覧可能にする。
    * リセット機能: 任意の範囲（全単語/特定単語）の正誤ステータスをリセットし、「覚えていない」状態に戻す機能を設ける。

#### 4.4.5. AIセマンティック検索
* **意味検索:** 単語そのものではなく「意味」や「概念」で検索可能なベクトル検索を実装する（例：「諦める」で検索 → "abandon", "resignation" 等がヒット）。

## 5. 技術要件・UI挙動詳細 (System Behavior)

### 5.1. 生成後のリアルタイム表示変更 (Realtime Reflection - Plan 2)

生成完了後、ユーザーがリロード操作を行わなくても、**自動的かつ瞬時に**画面表示が更新される仕組みを実装する。

* **仕組み (Supabase Realtime):**
    * クライアント（フロントエンド）は、表示中の単語データ（またはリスト全体）のデータベース変更を購読（Subscribe）する。
* **データフロー:**
    1.  **AI更新:** サーバー側（Edge Functions等）でAI生成が完了し、データベースの該当レコードが更新される。
    2.  **イベント発火:** データベースが更新イベント（UPDATE event）をブロードキャストする。
    3.  **クライアント検知:** フロントエンドがイベントを受知する。
    4.  **UI反映:** 受信した新しいデータ（Payload）を用いて、**ローカルの状態（State）を即座に書き換える**。
* **UX上の効果:**
    * ユーザーが一覧画面や詳細モーダルを見ている間に、項目の「生成中スピナー」がフッと消え、テキストがパッと現れる体験を実現する。

### 5.2. データ整合性 (Safe Merge Strategy)
* **差分更新の徹底:** フロントエンド・バックエンド共に、データの更新は常に`PATCH`（部分的更新）として扱い、`PUT`（全置換）は避ける。これにより、ユーザーの手動編集とAIの自動生成が競合した場合のリスクを最小化する。






